---------------------------- VISTAS ----------------------------

Las vistas se utilizan como si fuesen una función para poder "guardar una consulta" en ellas
Esto nos beneficia en que si queremos realizar un conjunto de subconsultas anidadas para obtener valores
podemos guardar dentro de una vista una serie de consultas que nos darán una TABLA VIRTUAL deseada para que luego 
podamos hacerle subconsultas a la misma.
Estas vistas (tablas virtuales) pueden escalar en complejidad tanto como deseemos (anidando subconsultas por ej)
En este caso se creará una tabla virtual con nombre y costo estimado de proyecto:

-- Creación:

CREATE VIEW VW_PRUEBA AS
SELECT P.Nombre, P.CostoEstimado 
FROM Proyectos P

-- Selección:

SELECT * From VW_PRUEBA

-- Modificación:

ALTER VIEW VW_PRUEBA AS
SELECT P.Nombre, P.CostoEstimado, P.Descripcion 
FROM Proyectos P

-- Eliminación:

DROP VIEW VW_PRUEBA

---------------------------- PROCEDIMIENTOS ALMACENADOS ----------------------------

Un procedimiento almacenado es un grupo de sentencias de SQL que son ejecutables. Mientras que una vista es una tabla 
virtual creada a partir de consultas en la que nosotros podemos realizarle consultas, en el procedimiento almacenado nosotros podemos
generar cambios en la base de datos. Es decir, un procedimiento almacenado puede recibir o no parámetros y generar modificaciones 
en base a los mismos.

-- Creación:

CREATE PROCEDURE SP_INSERTAR_CLIENTE(
    @Nombre varchar(20),
    @Apellido varchar(50),
    @Edad tinyint
) [Parametros]
AS 
BEGIN
    INSERT INTO Clientes (Nombre, Apellido, Edad)
    values (@Nombre, @Apellido, @Edad)
END

-- Ejecutar: 

EXECUTE SP_NOMBRE(@Params)

EXECUTE SP_INSERTAR_CLIENTE("Isidoro", "Arostegui", 23)


---------------------------- TRANSACCIONES ----------------------------

CREATE PROCEDURE spRegistrarMovimiento(
@nroCuenta VARCHAR(20),
@tipoMovimiento CHAR,
@descripcion VARCHAR(50),
@importe DECIMAL(10, 2)
) -- Parametros del procedimiento
AS
BEGIN

    BEGIN TRY -- Inicio bloque try

        BEGIN TRANSACTION -- Inicia la transacción
        IF @tipoMovimiento = 'D' OR @tipoMovimiento ='d' -- Si es un depósito
            BEGIN

            -- Declara las variables
            DECLARE @saldo DECIMAL(10, 2)
            DECLARE @tipoCuenta INT
            DECLARE @descubierto DECIMAL(10, 2)

            IF (SELECT COUNT(*) FROM cuentas WHERE nroCuenta = @nroCuenta) = 1 -- Si la cuenta es distinta de 0
                BEGIN -- Almacena en las viariables los datos de esa cuenta
                SELECT @saldo = C.saldo, @tipoCuenta = C.idTipoCuenta, @descubierto =  C.limite_descubierto FROM cuentas C WHERE C.nroCuenta = @nroCuenta
                END
            ELSE -- No hay tal cuenta
                BEGIN
                RAISERROR('NO EXISTE LA CUENTA', 16, 1)
                END
        -- Casos donde no se puede realizar la transferencia
        IF @saldo - @importe < 0 AND @tipoCuenta = 1
            BEGIN
            RAISERROR ('NO SE PUEDE REALIZAR EL MOVIMIENTO, SALDO ES INSUFICIENTE', 16, 1)
            END
        IF @saldo - @importe < (0 - @descubierto) AND @tipoCuenta = 2
            BEGIN
            RAISERROR ('NO SE PUEDE REALIZAR EL MOVIMIENTO, SALDO ES INSUFICIENTE', 16, 1)
            END
        END
            INSERT INTO movimientos (fecha, nrocuenta, descripcion, tipomovimiento, importe) 
            VALUES(GETDATE(), @nroCuenta, @descripcion, @tipoMovimiento, @importe) -- Realiza el depósito

        IF @tipoMovimiento = 'E' OR @tipoMovimiento = 'e'
        BEGIN
            SET @importe = @importe * -1
        END

        UPDATE cuentas SET saldo = saldo + @importe WHERE nroCuenta = @nroCuenta -- Se actualiza el saldo
        
        IF @@ROWCOUNT = 0 -- Si no se actualizó ninguna fila
        BEGIN
            RAISERROR('OCURRIO UN ERROR', 16, 1)
        END

        COMMIT TRANSACTION

    END TRY

    BEGIN CATCH

        PRINT ERROR_MESSAGE()
        ROLLBACK TRANSACTION

    END CATCH

END
